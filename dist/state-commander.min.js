/**
 * state-commander v0.0.2
 * (c) 2019 Aleksandar Vucic
 * @license MIT
 */
var e,t;e=this,t=function(e){"use strict";const t=e=>e&&"function"==typeof e.then;function n(e,t){if(!e)throw new Error(`[StateCommander] ${t}`)}function o({path:e="",command:t="",prefix:o=""}){n(e||t,"path or command required");const i=t.charAt(0).toLowerCase()+t.slice(1);return`${o}:${e.replace(/(\W)+\/|\.{1,2}\/|\.\w+$/g,"")}/${i}`.replace(/^[\/:]+/,"").replace(/\/\//,"/").replace(/:\//,":")}function i(e){return e.replace(/(\W)+\/|:after|:before|\.{1,2}\/|\.\w+$/g,"").replace(/^\//,"").replace(/:/g,"/").replace(/(\/{1,2}\w)/g,e=>e.toUpperCase().replace(/\/{1,2}/,""))}function s(e=""){const t={full:null,root:null,filePath:null,filename:null,ext:null};return e?(({0:t.full="",1:t.root="",2:t.filePath="",3:t.filename="",4:t.ext=""}=/^(\w:[\/\\]|[\/\\]|[.]+[\/\\]|^)(.*?)[\\\/]?([^.\\\/]+)(\.\w+$)?$/.exec(e)||[]),t):t}const r=e=>e.charAt(0).toLowerCase()+e.slice(1),a=e=>e[e.length-1],c=e=>e.slice(0,-1);class l{attach(e){this.execute=(t=>(...n)=>t(...c(n),()=>{const t=a(n);e.apply(this,[...c(n),t.bind.apply(t,[null,...c(n)])])}))(this.execute)}execute(...e){a(e).apply(this,c(e))}}const d={},m=[],u={},h={},p=["extend","name","description","initialize","reset"];class f{constructor(...e){m.filter(e=>e.initialize).forEach(t=>t.initialize(this,...e))}reset(){m.filter(e=>e.reset).forEach(e=>e.reset(this))}}var g={get Base(){return f},get hooks(){return d},get configuration(){return u},get definitions(){return h},get extensions(){return m},use(e,...t){n(e.name,"missing plugin name"),m.find(t=>t.name===e.name)||(e.hooks&&e.hooks.forEach(e=>{(function(e){n(/^[\w\/]+:\w+$/.test(e),"invalid hook name. It should be: pluginNamePrefix:hookName"),n(!this.hooks[e],`hook ${e} is already registered`),Object.assign(this.hooks,{[e]:new l})}).call(this,e)}),e.configuration&&function(e,t={}){const n=r(e);this.configuration[n]||Object.assign(this.configuration,{[n]:t})}.call(this,e.name,e.configuration),e.definition&&function(e={}){const[[t,o={}]=[]]=Object.entries(e);n(t&&Object.keys(o).length,"definition is empty"),n(!this.definitions[t],`definition ${t} already exists`),Object.entries(o).forEach(([,e])=>{n(Object.keys(e).length,"definition of action is empty"),n(e.handler instanceof Function,"missing handler"),n(e.invokeFn,"missing invokeFn")}),Object.assign(this.definitions,{[t]:e[t]})}.call(this,e.definition),e.install&&e.install(this,...t),p.filter(t=>e[t]),m.push(p.reduce((t,n)=>({...t,[n]:e[n]}),{})))},createClass(e){const[t="default",o]=e&&"string"!=typeof e?[void 0,e]:[e,{}],i=class extends this.Base{},s=this.definitions[t];return n(s,`definition ${t} not found`),i.definition=s,i.configuration=u,i._$factory=this,m.filter(e=>e.extend).forEach(e=>e.extend(i,o)),i}};const y=(e,t)=>{const[n,o]=[e.split("/"),t.split("/")];return o.filter((e,t)=>n[t]!==e).join("/")};class x{constructor(e=""){this._path="",this._namespace="",this.join(e)}get path(){return this._path}get moduleName(){return this._moduleName}get namespace(){return this._namespace}prepend(e=""){this.join(e,{prepend:!0})}join(e="",{prepend:t=!1}={}){const n=s(this._path),o=s(e);if(!n.full)return function(e){this._moduleName=e.filename,this._path||(this._path=e.full),this._namespace=[e.filePath,e.filename].filter(Boolean).join("/").replace(/^\W+/,""),this._extension=e.ext}.call(this,o),this;if(!o.full)return this;const[i,r]=t?[o,n]:[n,o],a=y(i.filePath,r.filePath);return this._namespace=[i.filePath,i.filename,a,r.filename].filter(Boolean).join("/"),this}}const _={rootModuleName:"root"},k={};function b(){return this._modules}function v(e){return this._modules[e]}function C(e,{commands:t=[]}={}){n("string"==typeof e||e&&"Module"===e.constructor.name,"argument must be string (path) or instance of Module");const o="string"==typeof e?this.constructor.Module.create(this,e,{commands:t}):e;return k["module:register"].execute({module:o},this,()=>{const e=o.registrationKey;n(e,"registration key is missing"),n(!this._modules[e],"module already exists"),this._modules[e]=o}),o}function j(e){n("string"==typeof e||e&&"Module"===e.constructor.name,"argument must be string (path) or instance of Module");const t=e.registrationKey?e:this.getModule(e);t&&k["module:unregister"].execute({module:t},this,()=>{t.unregisterAllCommands(),delete this._modules[t.registrationKey]})}const O={Base:class{registerCommand(e){const t=e;n(e&&[e.prototype.execute,e.prototype.commit,e.prototype.getter&&e.state].some(e=>e),`invalid command class ${e.name}.\n    class must have declared at least:\n    execute, commit or getter with state property`);const{definition:i,Handler:s}=this.context.constructor;n(i,"Missing context definition"),n(s,"Handler extension is required"),k["module:registerCommand"].execute({command:e},this,()=>{t.registrationKey=o({path:this.namespace,command:e.name}),Object.entries(i).forEach(([,n])=>{const o=n.invokeFn.name?n.invokeFn.name:n.invokeFn;if("function"==typeof e.prototype[o]){const o=s.create(this,e,n);Object.defineProperty(o,"command",{get:()=>t}),this.context[`_${n.map}`][o.registrationKey]=o}}),this._commands.push(e)})}unregisterCommand(e){const{definition:t}=this.context.constructor;n(t,"Missing context definition"),k["module:unregisterCommand"].execute({command:e},this,()=>{Object.entries(t).forEach(([,t])=>{delete this.context[`_${t.map}`][e.registrationKey]}),this._commands=this._commands.filter(t=>t.registrationKey!==e.registrationKey)})}getCommands(){return this._commands}unregisterAllCommands(){return this._commands.forEach(e=>this.unregisterCommand(e))}},create(e,t,{commands:n=[],name:o=_.rootModuleName}={}){const i=new x(t),s=new class extends this.Base{};return Object.defineProperty(s,"context",{get:()=>e}),Object.defineProperty(s,"_pathParser",{get:()=>i}),Object.defineProperty(s,"path",{get:()=>s._pathParser.path}),Object.defineProperty(s,"namespace",{get:()=>s._pathParser.namespace}),Object.defineProperty(s,"name",{get:()=>o||s._pathParser.moduleName}),Object.defineProperty(s,"registrationKey",{get:()=>(s._pathParser.namespace||s._pathParser.moduleName||s.name).toLowerCase()}),s._commands=[],n.forEach(e=>s.registerCommand(e)),s}};var M={name:"Module",hooks:["module:register","module:unregister","module:registerCommand","module:unregisterCommand"],configuration:_,install(e){const t=e;t.Module=O,k["module:register"]=t.hooks["module:register"],k["module:unregister"]=t.hooks["module:unregister"],k["module:registerCommand"]=t.hooks["module:registerCommand"],k["module:unregisterCommand"]=t.hooks["module:unregisterCommand"],t.Base.Module=t.Module,t.Base.prototype.getModule=v,t.Base.prototype.getModules=b,t.Base.prototype.registerModule=C,t.Base.prototype.unregisterModule=j},initialize(e,{commands:t=[]}={}){const n=e;n._modules=Object.create(null),n.registerModule(n.constructor.Module.create(n,null,{commands:t}))}},P={name:"DefaultDefinition",definition:{default:{initializer:{prefix:"init",map:"initializers",invokeFn:"initialize",handler:function(e){return/\*/.test(e||"")?this._callAllCommands(this._initializers,e):this._callCommand(this._initializers,e)}},action:{map:"actions",invokeFn:"execute",handler:function(e,t){return this._callCommand(this._actions,e,t)}},mutation:{map:"mutations",prefix:"commit",invokeFn:"commit",handler:function(e,t){return this._callCommandSync(this._mutations,e,t)}}}},initialize(e){const t=e;Object.entries(t.constructor.definition).forEach(([,e])=>{e.map&&(t[`_${e.map}`]=Object.create(null)),t[e.handler.name]=(n,o)=>e.handler.call(t,e.prefix?`${e.prefix}:${n}`:n,o)})}};const w={},S={Base:class{constructor(e){this._invokeFn=e}invoke(e,t){let n;return w["handler:invoke"].execute({event:e,payload:t,context:this},()=>{n=this._invokeFn(e,t)}),n}},createClass:()=>(class extends this.Base{}),create(e,t,n){const{invokeFn:i}=n,s=new(this.createClass());return Object.defineProperty(s,"module",{get:()=>e}),Object.defineProperty(s,"_definition",{get:()=>n}),Object.defineProperty(s,"_invokeFn",{get:()=>(...e)=>i instanceof Function?i(new t(...e)):new t(...e)[i]()}),Object.defineProperty(s,"registrationKey",{get:()=>o({path:e.namespace,command:t.name,prefix:n.prefix})}),s}};var $={name:"Handler",hooks:["handler:invoke"],install(e){const t=e;t.Handler=S,w["handler:invoke"]=t.hooks["handler:invoke"],t.Base.Handler=t.Handler}};const B={},F={},E=e=>new RegExp(/\/*/.test(e)?e.replace("*","(.*?)"):"a^");function K(e,t,n){let o;return B["command:invoke"].execute({map:e,event:t,payload:n},this,()=>{const i=e[t];o=i?i.invoke(t,n):this._commandNotFound(t,n)}),o}function H(e,t){F.notFoundHandler()(e,t)}function N(e,n,o){const i=this._callCommandSync(e,n,o);return t(i)?i:Promise.resolve(i)}function z(e,t,n){if(/\/*/.test(t)){const o=E(t);return Promise.all(Object.keys(e).reduce((t,i)=>(o.test(i)&&t.push(this._callCommand(e,i,n)),t),[]))}return Promise.all([])}var A={name:"CommandDispatcher",hooks:["command:invoke"],install(e){const t=e,o=t.Base.prototype;o._callCommand=N,o._callCommandSync=K,o._callAllCommands=z,o._commandNotFound=H,F.notFoundHandler=()=>t.configuration.notFoundHandler||(e=>n(!1,`Command not found ${e}`)),B["command:invoke"]=t.hooks["command:invoke"]}};const L={buildState:(e={})=>e,setState:(e,t,n)=>Object.assign(e,{[t]:n})},D={};function q(e,t=!1){const n=e;n._state&&!1===t||(n.getters={},n._state=L.buildState({}))}function W(e,t,{override:o=!1}={}){n(e,"missing key for state registration"),q(this),D["state:register"].execute({key:e,state:t},this,()=>{n(!(!1===o&&this._state[e]),`state for ${e} already exists `),L.setState(this._state,e,t)})}function I(e){D["state:unregister"].execute({key:e},this,()=>{delete this.getters[e],Object.getOwnPropertyNames(this.getters).forEach(t=>{t.startsWith(e)&&delete this.getters[t]}),delete this._state[e]})}const V=({module:e},t,n)=>{q(t),n();const o=e.registrationKey;t.state[o]||t.registerState(o,{})},G=({module:e},t,n)=>{n(),e.context.unregisterState(e.registrationKey)},R=({command:e},t,n)=>{q(t.context),n();const o=e,{state:i={},registrationKey:s}=o,{getters:r,state:a}=t.context;o.prototype.rootState=a;const c=t.registrationKey;a[c]||t.context.registerState(c,{});const l=a[c];Object.keys(i).forEach(e=>{if(!l[e]){const t=Object.getOwnPropertyDescriptor(i,e);t.writable?L.setState(l,e,i[e]):Object.defineProperty(l,e,t)}}),o.prototype.state=l,r[s]||"function"!=typeof o.prototype.getter||Object.defineProperty(r,s,{get:()=>(new o).getter(),configurable:!0})},T=({command:e},t,n)=>{n(),t.context.unregisterState(e.registrationKey)};var U={name:"State",hooks:["state:register","state:unregister"],configuration:L,install(e){const t=e;t.State=this,Object.defineProperty(t.Base.prototype,"state",{get(){return q(this),this._state}}),t.Base.prototype.registerState=W,t.Base.prototype.unregisterState=I,n(t.Module,"Missing Module which is required by State"),D["state:register"]=t.hooks["state:register"],D["state:unregister"]=t.hooks["state:unregister"],t.hooks["module:register"].attach(V),t.hooks["module:unregister"].attach(G),t.hooks["module:registerCommand"].attach(R),t.hooks["module:unregisterCommand"].attach(T)},initialize(e){q(e)},reset(e){q(e,!0)}};const J={statsPrinter:e=>console.table(e)};function Q(){return J.statsPrinter(this._stats)}const X=({event:e},t,n)=>{n();const o=t;o._stats[e]=o._stats[e]||0,o._stats[e]+=1};var Y={name:"CommandStats",description:"Plugin description",configuration:J,install(e){const t=e;t.Base.prototype.printStats=Q,t.hooks["command:invoke"].attach(X)},initialize(e){this.reset(e)},reset(e){e._stats={}}};function Z(e){return n(e&&"Module"===e.constructor.name,"argument must be string (path) or instance of Module"),this.context.unregisterModule(e),e._pathParser.prepend(this.path),this.context.registerModule(e),this}var ee={name:"ModuleInheritance",install(e){e.Module.Base.prototype.addChild=Z}},te={name:"ModuleMapper",description:"Parse modules map input",initialize(e,t){this.reset(e,t)},reset(e,t={}){Object.entries(t).forEach(([t,{state:n,commands:o=[]}={}])=>{const i=e.registerModule(t,{commands:o});n&&e.registerState(i.namespace,n,{override:!0})})}};const ne=e=>"function"==typeof e?e.name:e,oe=(e,t,n)=>e||i(`${t||""}/${n}`),ie=({command:e},t,n)=>{const{context:o}=t;o._helpers||(o._helpers={}),n();const i=e,{helpers:s={},registrationKey:r}=i,{getters:a}=o,{definition:c}=o.constructor;if(Object.values(c).forEach(e=>{const t=ne(e.invokeFn);if("function"==typeof i.prototype[t]){const n=s[t]||oe(null,e.prefix,r);if(!o._helpers[n]){const t=e.handler.name,i=o[t];o._helpers[n]=e=>i(r,e)}}}),"function"==typeof i.prototype.getter){const e=oe(s.getter,"get",r);o._helpers[e]||(o._helpers[e]=()=>a[r])}},se=({command:e},t,n)=>{n();const o=e,{helpers:i={},registrationKey:s}=o,{context:r}=t,{definition:a}=r.constructor,c=oe(i.getter,"get",s);delete r._helpers[c],Object.values(a).forEach(e=>{const t=ne(e.invokeFn),n=i[t]||oe(null,e.prefix,s);delete r._helpers[n]})};function re(){return this._helpers}var ae={name:"CommandHelpers",description:"Generate helper methods for registered commands",install(e){const t=e;n(t.State,"Missing State which is required by Command Helpers"),t.hooks["module:registerCommand"].attach(ie),t.hooks["module:unregisterCommand"].attach(se),t.Base.prototype.getHelpers=re},initialize(e){n(!Object.values(e.constructor.definition).some(e=>/get/i.test(e.prefix)),"prefix GET is reserved and used by CommandHelpers module. Please consider to define different prefix in context definition")}};function ce(){const e=this.$options;e.context?this.$context="function"==typeof e.context?e.context():e.context:e.parent&&e.parent.$context&&(this.$context=e.parent.$context)}const le={install(e){e.mixin({beforeCreate:ce})}};var de={name:"VueContext",description:"Connect State Commander with Vue",install(e,{vue:t}){const n=e;n.configuration.state.buildState=(e={})=>t.observable(e),n.configuration.state.setState=(e,n,o)=>(function e(t,n,o){t[n]||this.set(t,n,{}),o&&"object"==typeof o&&!Array.isArray(o)?Object.entries(o).forEach(([o,i])=>{e.call(this,t[n],o,i)}):t[n]=o}).call(t,e,n,o),t.use(le)}};const me=({event:e,payload:t},n,o)=>{((e,t="No data")=>{console.log(`%cCOMMAND%c${e}`,"background: #009688; color: white; padding: 2px 4px; border-radius: 3px 0 0 3px; font-weight: bold;","background: #dadedf; color: rgba(0,0,0,0.87); padding: 2px 4px; border-radius: 0 3px 3px 0; font-weight: bold;",t)})(e,t),o()};var ue={name:"Logger",description:"Log command execution",install(e){e.hooks["command:invoke"].attach(me)}};g.use(P),g.use(A),g.use(M),g.use($),g.use(U),e.CommandHelpers=ae,e.Context=g,e.Logger=ue,e.ModuleInheritance=ee,e.ModuleMapper=te,e.Stats=Y,e.VueContext=de,e.makeHelperName=i,e.makeRegistrationKey=o,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).StateCommander={});